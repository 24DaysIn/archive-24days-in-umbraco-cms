<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">


	<title>Cache busting with a partial view</title>
<meta name="description" content="How to create a partial view you can use for automatic cache busting of static content, based on latest write time of the static file.">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="/assets/24days-archive.css">
	<link rel="apple-touch-icon" href="/assets/24days-touch-icon.png">
		
	
	
</head>
<body>
	



<section class="page"><main class="article"><header><h1 class="header">Bust a cache</h1>
      <p class="byline"> by Jesper Hauge, <span class="pubdate">posted on <time datetime="2013-12-03">Dec 3, 2013</time></span></p></header><div class="notification warning">
      <h2>Heads Up!</h2>
      <p>
					This article is several years old now, and much has happened since then,
					so please keep that in mind while reading it.
				</p>
    </div>
    <div class="content-column">
      <p class="teaser">Ever had the following conversation with a client?</p>
<blockquote>
<p><em>Client</em>: "I just checked the website to see the changes you told me you'd deployed, but I can't see any. Are you sure you actually deployed it?"</p>
<p><em>You</em>: "Are you looking at it in your browser now?"</p>
<p><em>Client</em>: "Yes"</p>
<p><em>You</em>: "Try holding down the Ctrl key and press F5"</p>
<p><em>Client</em>: "Wait I'll put down my phone . . Ooooh there it is, what did you do?"</p>
<p><em>You</em>: "Never mind".</p>
</blockquote>
<p class="intro">Then you probably wished you've gotten around to implement some form of <a href="http://madskristensen.net/post/cache-busting-in-aspnet">cache</a> <a href="http://community.rightpoint.com/blogs/viewpoint/archive/2011/12/01/combine-minify-compress-and-cache-bust-javascript-and-css-files-with-clientdependency-framework.aspx">busting</a> <a href="http://codebetter.com/karlseguin/2010/01/11/asp-net-performance-part-3-cache-busting/">technique</a> with the website you'd deployed.</p>
<h3>Cache busting with a partial view</h3>
<p>Here's how to do some cache busting using a partial view. To get ready: Log in to your favorite CMS go to the <code>Settings</code> section, and create a new partial view.</p>
<p>In the view insert the following code.</p>
<pre class="language-javascript"><code>@inherits Umbraco.Web.Mvc.UmbracoTemplatePage
@using File = System.IO.File
@{
    Layout = null;

    // Grab the url and find the file
    var url = (string)ViewData["href"];
    var path = Server.MapPath(url);
    var exists = File.Exists(path);

    // Determine file type
    var fileType = Path.GetExtension(path);
    if ("|.png|.gif|.jpg|.jpeg|".Contains(fileType))
    {
        fileType = "img";
    }

    // Check if the file exists
    if (exists)
    {
        // Latest write time of the file
        DateTime date = File.GetLastWriteTime(path);
        // Build an url with a parameter that reflects last write time
        url = string.Format("{0}?v={1}", url, date.Ticks);
    }
    else
    {
        fileType = string.Empty;    
    }
}

@switch (fileType)
{
    case ".css":
        &lt;link rel="stylesheet" href="@url" /&gt;
        break;
    case ".js":
        &lt;script type="text/javascript" src="@url"&gt;&lt;/script&gt;
        break;
    case "img":
        &lt;img src="@url" alt="@ViewData["altTxt"]" width="@ViewData["width"]" /&gt;
        break;
    default:
        &lt;!-- No versionable file found at @url --&gt;
        break;
}</code></pre>
      <p class="snippet-caption">The partial view to use for fingerprinting your URL</p>
<p>With this partial view you are able to include CSS, JavaScript and image resources in your code, that'll automatically get versioned. Every time you save the file on the server, it will get a new version parameter on the query string causing your browsers to redownload the resource.</p>
<p>As you see in the partial it's possible to add strings for alt-, width- and height-attributes when using the partial for images, for this I'm using the possibility for adding a ViewDataDictionary as a parameter in the call to <code>Html.Partial</code>. The ViewDataDictionary is a key/value dictionary made available in your Razor script as <code>@ViewData</code>, and it is easily declared when using the Partial view with the Html-helper in a view. The Partial can be used in these ways:</p>
<pre class="language-javascript"><code>// Stylesheet
@Html.Partial("FingerprintUrl", new ViewDataDictionary{{"href", "/css/site.css"}})

// Javascript file
@Html.Partial("FingerprintUrl", new ViewDataDictionary{{"href", "/scripts/frontpage.js"}})

// Image file
@Html.Partial("FingerprintUrl", new ViewDataDictionary{{"href", "/images/20130831-DSC_0030.jpg"}, {"altTxt", "Bulbs"}, {"width", "960px"}})
</code></pre>
      <p class="snippet-caption">How to use the partial above</p>
<h3>Bonusinfo</h3>
<p>It's now possible to control the caching of your static resources, and you can put this is in your Umbraco project just by creating a partial view using the excellent Umbraco backend.</p>
<p>But you might like to know how you can set up a really, really long caching period for your static ressources since you're now able to force the client-browsers to download the newer version every time you update the file.</p>
<p>This cannot be done from the Umbraco backend, so you might have to ask the webserver administrator to set it for your IIS website, or if you have access to your website filesystem via FTP or RDP or something else, you could just put the following XML-snippet in place:</p>
<pre class="language-markup"><code>&lt;system.webServer&gt;
    &lt;staticContent&gt; 
      &lt;clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="365:00:00" /&gt; 
    &lt;/staticContent&gt;
&lt;/system.webServer&gt;
</code></pre>
      <p class="snippet-caption">Add cache busting to your web.config file</p>
<p>In an ordinary Umbraco website, the <code>&lt;staticContent&gt;</code> node will already be in place, so you should just add the clientCache node to the existing node.</p>
<p>This setting will cache all your static content in the client browsers for 365 days. If you're trying to do cache busting while developing your site in Visual Studio, or just want to do this using a proper HtmlHelper function, you can read my take on <a href="http://blog.iqit.dk/2013/11/a-htmlhelper-to-help-with-cache-busting" target="_blank" title="Create a cache busting HtmlHelper method">cache busting with the HtmlHelper</a>.</p>
<h3>That's it</h3>
<p>Have a nice holiday season, and while you're away from your computer why not <a href="https://www.youtube.com/watch?v=9wJCmtZMc1g" title="Young MC - Bust a Move">Bust a Move</a> instead.</p>
    </div><footer><ul class="tags">
        <li><a rel="tag" href="/umbraco-cms/tags/caching/" title="See all articles tagged with Caching">Caching</a></li>
        <li><a rel="tag" href="/umbraco-cms/tags/mvc/" title="See all articles tagged with MVC">MVC</a></li>
        <li><a rel="tag" href="/umbraco-cms/tags/v4/" title="See all articles tagged with v4">v4</a></li>
        <li><a rel="tag" href="/umbraco-cms/tags/v6/" title="See all articles tagged with v6">v6</a></li>
      </ul></footer><section class="bios"><div class="bio">
        <div class="gravatar" title="Jesper Hauge"><img src="//gravatar.com/avatar/04e637cc3e9390d323e47fecc9e84193.jpg?d=mm&amp;s=150" srcset="//gravatar.com/avatar/04e637cc3e9390d323e47fecc9e84193.jpg?d=mm&amp;s=300 2x" width="150" height="150"></div>
        <h1>Jesper Hauge</h1>
        <p>Jesper is on Twitter as <a href="//twitter.com/jhauge" title="Jesper Hauge on Twitter" rel="author">@jhauge</a></p>
      </div></section><section class="comments"><div id="disqus_thread"></div></section></main><nav class="dates-navbar"><a href="/umbraco-cms/2013/" class="home-link"><span class="scr-text">Home</span></a><ol>
      <li><a title="Editor-proofing Umbraco" href="/umbraco-cms/2013/editor-proofing-umbraco/"><span class="scr-text">Editor-proofing Umbraco</span></a></li>
      <li><a title="All your logs are belong to log4net" href="/umbraco-cms/2013/log4net-in-umbraco/"><span class="scr-text">All your logs are belong to log4net</span></a></li>
      <li class="selected"><a title="Bust a cache" href="/umbraco-cms/2013/cache-busting/"><span class="scr-text">Bust a cache</span></a></li>
      <li><a title="Get More Out of Umbraco Using Server-Side Caching Strategies" href="/umbraco-cms/2013/get-more-out-of-umbraco-using-server-side-caching-strategies/"><span class="scr-text">Get More Out of Umbraco Using Server-Side Caching Strategies</span></a></li>
      <li><a title="How GitHub Snippets for Umbraco 7 was built" href="/umbraco-cms/2013/github-snippets-for-umbraco/"><span class="scr-text">How GitHub Snippets for Umbraco 7 was built</span></a></li>
      <li><a title="6 Easy Configuration Tweaks" href="/umbraco-cms/2013/6-easy-configuration-tweaks/"><span class="scr-text">6 Easy Configuration Tweaks</span></a></li>
      <li><a title="Mapping Umbraco content to POCOs for strongly typed views" href="/umbraco-cms/2013/mapping-content-to-pocos/"><span class="scr-text">Mapping Umbraco content to POCOs for strongly typed views</span></a></li>
      <li><a title="The worlds friendliest post on getting started with Examine" href="/umbraco-cms/2013/getting-started-with-examine/"><span class="scr-text">The worlds friendliest post on getting started with Examine</span></a></li>
      <li><a title="Creating reusable code in MVC apps" href="/umbraco-cms/2013/creating-reusable-code-in-mvc-apps/"><span class="scr-text">Creating reusable code in MVC apps</span></a></li>
      <li><a title="Why you should care about emotions when building a web shop" href="/umbraco-cms/2013/emotional-commerce/"><span class="scr-text">Why you should care about emotions when building a web shop</span></a></li>
      <li><a title="How And Why We Do Umbraco MVC" href="/umbraco-cms/2013/how-and-why-we-do-umbraco-mvc/"><span class="scr-text">How And Why We Do Umbraco MVC</span></a></li>
      <li><a title="The Dictionary Secrets" href="/umbraco-cms/2013/the-dictionary-secrets/"><span class="scr-text">The Dictionary Secrets</span></a></li>
      <li><a title="Data = Knowledge" href="/umbraco-cms/2013/data-=-knowledge/"><span class="scr-text">Data = Knowledge</span></a></li>
      <li><a title="Content-First in Umbraco" href="/umbraco-cms/2013/content-first/"><span class="scr-text">Content-First in Umbraco</span></a></li>
      <li><a title="Hybrid Framework" href="/umbraco-cms/2013/hybrid-framework/"><span class="scr-text">Hybrid Framework</span></a></li>
      <li><a title="The uSync Soft Shoe Shuffle" href="/umbraco-cms/2013/the-usync-soft-shoe-shuffle/"><span class="scr-text">The uSync Soft Shoe Shuffle</span></a></li>
      <li><a title="No More Empty Tabs, Please " href="/umbraco-cms/2013/empty-tabs/"><span class="scr-text">No More Empty Tabs, Please </span></a></li>
      <li><a title="Sharing is caring - The 301 Url Tracker" href="/umbraco-cms/2013/sharing-is-caring/"><span class="scr-text">Sharing is caring - The 301 Url Tracker</span></a></li>
      <li><a title="Umbraco V7 Compatible packages" href="/umbraco-cms/2013/v7-packages/"><span class="scr-text">Umbraco V7 Compatible packages</span></a></li>
      <li><a title="What's in a Document Type anyway?" href="/umbraco-cms/2013/documenttypes/"><span class="scr-text">What's in a Document Type anyway?</span></a></li>
      <li><a title="One member to rule them all" href="/umbraco-cms/2013/one-member-to-rule-them-all/"><span class="scr-text">One member to rule them all</span></a></li>
      <li><a title="Injecting the backoffice into the backoffice" href="/umbraco-cms/2013/injecting-the-backoffice-into-the-backoffice/"><span class="scr-text">Injecting the backoffice into the backoffice</span></a></li>
      <li><a title="Dashboard overload" href="/umbraco-cms/2013/dashboard-overload/"><span class="scr-text">Dashboard overload</span></a></li>
      <li><a title="Christmas Edition" href="/umbraco-cms/2013/christmas-edition/"><span class="scr-text">Christmas Edition</span></a></li>
    </ol></nav></section>


	<script type="module" src="/assets/ipuzzler.js"></script>
	<script defer src="/assets/libs.min.js"></script>
	<script defer src="/assets/app.js"></script>
	
</body>
</html>
