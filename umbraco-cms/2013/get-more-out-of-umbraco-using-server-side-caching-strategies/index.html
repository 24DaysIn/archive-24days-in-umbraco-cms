<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">


	<title>Get More Out of Umbraco Using Server-Side Caching Strategies</title>
<meta name="description" content="Even though Umbraco does cache the data and keeps us insulated from DB requests, large datasets will eventually result in longer lookup and load times as models are pieced together for each request. After using a mix of the caching strategies outlined here, the CPU spikes on the server disappeared during high volume loads. Caching your data is especially helpful if the data has a large flat tree structure or there is an unavoidable expensive operation. Just be mindful of when to clear the cache and when not to. Clearing the cache too often negates the benefits.">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="/assets/24days-archive.css">
	<link rel="apple-touch-icon" href="/assets/24days-touch-icon.png">
		
	
	
</head>
<body>
	



<section class="page"><main class="article"><header><h1 class="header">Get More Out of Umbraco Using Server-Side Caching Strategies</h1>
      <p class="byline"> by Kevin Giszewski, <span class="pubdate">posted on <time datetime="2013-12-04">Dec 4, 2013</time></span></p></header><div class="notification warning">
      <h2>Heads Up!</h2>
      <p>
					This article is several years old now, and much has happened since then,
					so please keep that in mind while reading it.
				</p>
    </div>
    <div class="content-column">
      <p class="teaser">Umbraco has a wonderful way of keeping visitors to our sites happy by leveraging caching of published content. Each property on every document gets saved to the cache and can be served lightning fast as discrete pieces of data.  This is usually just fantastic for use on most sites and visitors will be blissful. However a lot of sites I build have fairly complex data models which have to be constructed from the bits and pieces of data cached into the Umbraco.config file.  After each request the models are discarded and the process repeats for each subsequent visitor.  Add some decent traffic and the shear lookup and business logic processing can begin to tax the CPU.  Ramp up the traffic a bit more and the site can become unresponsive.</p>
<h2>So what can be done to avoid CPU spikes?</h2>
<p class="intro">Just get a bigger/faster server right?  Well before you scale with brute force you should consider refactoring your code to eliminate bottlenecks.  On one particular site I ran the built-in Umbraco Profiler along with the Visual Studio 2012 profiler to find bottlenecks.  After deciding that the operation causing the trouble couldn't be refactored to improve performance (due to business rules) and refactoring the ones that could be optimized, I came up with three caching strategies to overcome the server spikes:</p>
<p><strong>1. The Built-in Umbraco CachedPartial()</strong></p>
<p>Umbraco has a built-in partial cacher which can easily cache a partial by page, by member and expire after a given amount of time. This is wonderful for a lot of uses where the page does not need to be dynamic past page\member combinations. However the particular site I was building needed to be cached by city\state which added the need for a custom key to be passed to Umbraco which presently does not allow for.</p>
<p><strong>2. Custom Partial Cache</strong></p>
<p>So since the built-in partial cacher didn't meet my needs, I examined the core and quickly put together my own cacher. My cacher then globbed together visitors by city\state and kept everyone visiting quickly. I was able to determine my own rules for cache clearing and which partials were cached and which were not.  For this example, the user's current location is held in a "User" object.</p>
<p>This snippet is my custom cacher which was built based on the Umbraco Core source:</p>
<pre class="language-csharp"><code>//the custom cacher

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Web;
using System.Web.Caching;
using System.Web.Mvc;
using System.Web.Mvc.Html;
using System.Web.Script.Serialization;
using System.Text.RegularExpressions;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Web;
using MyConstants;

namespace MyProject.Umbraco.Extended
{
    public static class PartialCacher
    {
        //an extension method is created to be used in the views
        public static IHtmlString MyCachedPartial(
                        this HtmlHelper htmlHelper,
                        string partialViewName,
                        object model,
                        int cachedSeconds,
                        ViewDataDictionary viewData = null,
                        string customKey = "",
                        bool logPartial = false
            )
        {           

            //the key will determine the uniqueness of the cache
            //the key ends up looking like this {prefix-url-customkey}
            var cacheKey = new StringBuilder();
            cacheKey.Append(MyConstants.PARTIAL_CACHE_PREFIX);

            cacheKey.Append(HttpContext.Current.Request.Url);
          
            if(customKey != "")
                cacheKey.Append("-" + customKey);

            var finalCacheKey = cacheKey.ToString().ToLower();

            if(logPartial)
                LogHelper.Info&lt;IHtmlString&gt;(partialViewName + " Partial Cacher Key=&gt; " + finalCacheKey);

            //this code was lifted from the Umbraco Core and does the actual caching/retrieval of html
            return ApplicationContext.Current.ApplicationCache.GetCacheItem(
                    finalCacheKey,
                    CacheItemPriority.NotRemovable, //not removable, the same as macros (apparently issue #27610)
                    null,
                    new TimeSpan(0, 0, 0, cachedSeconds),
                    () =&gt; htmlHelper.Partial(partialViewName, model, viewData));
        }
    }
</code></pre>
      <p class="snippet-caption">The Custom Partial Cacher</p>
<p>Using the Custom Partial Cacher in a view is easy:</p>
<pre class="language-csharp"><code>//usage in view
@Html.MyCachedPartial("MyView", new MyModel(), 86400, null, User.CurrentLocation.City + "-" + User.CurrentLocation.State)</code></pre>
      <p class="snippet-caption">View Usage</p>
<p>Then of course we have to come up with rules on when to clear it.  For my needs I cleared it every time document was published:</p>
<pre class="language-csharp"><code>//clear cache on publish
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Logging;
using Umbraco.Core.Publishing;
using Umbraco.Web;
using umbraco.interfaces;

namespace MyProject.Umbraco.Extended
{
    public class PublishingRules : ApplicationEventHandler
    {
        protected override void ApplicationStarting(UmbracoApplicationBase umbracoApplication, ApplicationContext applicationContext)
        {
            base.ApplicationStarting(umbracoApplication, applicationContext);

            PublishingStrategy.Published += PublishingStrategy_Published;
        }

        void PublishingStrategy_Published(IPublishingStrategy sender, global::Umbraco.Core.Events.PublishEventArgs&lt;IContent&gt; e)
        {         
            //we will clear the cache on each publish
            //the ClearCacheByKeySearch method clears cache items starting with the string provided.
            ApplicationContext.Current.ApplicationCache.ClearCacheByKeySearch(MyConstants.PARTIAL_CACHE_PREFIX);
            LogHelper.Info&lt;PublishingRules&gt;("Partial Cache cleared due to publish.");
        }
    }
}</code></pre>
      <p class="snippet-caption">How to Clear the Cache</p>
<p><strong>3. Singleton Cache</strong></p>
<p>Finally, if you'd like to build a cache that works in views AND the backoffice, you could always press a Singleton (or several) into service.  I've set up many Singletons to represent the site settings node, pools of data and slow loading view models. What happens here is a lazy lookup cache is loaded on first usage of the data. The data is then cleared based on any rules you decide. As you see in my example, a complex expensive data object could be lazy loaded on first usage, then each subsequent request would simply just use the cached data.  I've taken care to make the Singleton thread-safe by using a double-check lock.  The best part is this Singleton cache can be cleared and rebuilt as needed.</p>
<p>The Singleton Cache:</p>
<pre class="language-csharp"><code>//the Singleton Cache
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Umbraco.Core.Models;
using Umbraco.Web;
using Umbraco.Core.Logging;

namespace MyProject.Umbraco.Extended
{
    //the Singleton class
    public sealed class MyHighLevelCache
    {
        private static volatile MyHighLevelCache instance;
        private static object padLock = new Object();

        private MyHighLevelCache() { }

        //this is what we will cache
        public SomeOtherwiseExpensivelyCreatedObject MyCachedData
        {
            get;
            private set;
        }

        //this is the magic
        public static MyHighLevelCache Instance
        {
            get
            {
                if (instance == null)
                {
                    //thread safety
                    lock (padLock){
                    
                        if (instance == null)
                        {
                            instance = new MyHighLevelCache();
                            
                            //this is where you will build your data once instead of looking it up and building it on each request
                            MyCachedData = new SomeOtherwiseExpensivelyCreatedObject();
                            
                            LogHelper.Info&lt;MyHighLevelCache&gt;("MyHighLevelCache Created");
                        }
                    }
                }
                return instance;
            }
        }

        public void ClearCache()
        {
            if(instance != null){
            
                //thread safety
                lock(padLock){
            
                    if(instance != null){
                        LogHelper.Info&lt;MyHighLevelCache&gt;("MyHighLevelCache Cleared");
                        instance = null;
                    }
                 }
            }
        }
    }
}</code></pre>
      <p class="snippet-caption">The Singleton Cache</p>
<p>You can literally use this wherever you need and it will lazy load the data and persist it until you clear it:</p>
<pre class="language-csharp"><code>///usage, can be used on views or in other code
MyHighLevelCache.Instance.MyCachedData.Whatever;</code></pre>
      <p class="snippet-caption">Use anywhere in your code</p>
<p>Of course if your data doesn't change, then you don't need to do this; but dynamic CMS's need to update from time to time:</p>
<pre class="language-csharp"><code>//clear cache usage
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Logging;
using Umbraco.Core.Publishing;
using Umbraco.Web;
using umbraco.interfaces;

namespace MyProject.Umbraco.Extended
{
    public class PublishingRules : ApplicationEventHandler
    {
        protected override void ApplicationStarting(UmbracoApplicationBase umbracoApplication, ApplicationContext applicationContext)
        {
            base.ApplicationStarting(umbracoApplication, applicationContext);

            PublishingStrategy.Published += PublishingStrategy_Published;
        }

        void PublishingStrategy_Published(IPublishingStrategy sender, global::Umbraco.Core.Events.PublishEventArgs&lt;IContent&gt; e)
        {        
            //we are going to clear our cache if someone publishes a 'SomethingIamCaching' document type.
            var clearMyHighLevelCache = false;

            foreach (var node in e.PublishedEntities)
            {
                if (node.ContentType.Alias == "SomethingIamCaching")
                {
                    clearMyHighLevelCache = true;
                }
            }

            //let's only clear the cache once instead of per document
            if (clearMyHighLevelCache)
            {
                MyHighLevelCache.Instance.ClearCache();
            }
        }
    }
}</code></pre>
      <p class="snippet-caption">Clear Singleton Cache Usage</p>
<p><strong>Summing It Up</strong></p>
<p>Even though Umbraco does cache the data and keeps us insulated from DB requests, large datasets will eventually result in longer lookup and load times as models are pieced together for each request.  After using a mix of the caching strategies outlined here, the CPU spikes on the server disappeared during high volume loads.  Caching your data is especially helpful if the data has a large flat tree structure or there is an unavoidable expensive operation.  Just be mindful of when to clear the cache and when not to because clearing the cache too often negates the benefits.</p>
<p>Please note that these caching strategies cache into memory as opposed to a physical disk.  So make sure you have a little headspace with respect to RAM.  The amount of RAM needed (not much) vs CPU savings (a lot) can be dramatic.</p>
<p><strong>A Note About Load-Balancing</strong></p>
<p>I've used option 2 &amp; 3 with success in a load-balanced environment.  The trick to that is sending a signal from the admin server to the load-balanced servers.  I overcame this by setting up surface controller actions that cleared the local caches.  The admin node iterated through the &lt;server/&gt; nodes of the UmbracoSettings.config and visited the url's as needed (maybe on publish or whatever).  My colleague Tom Fulton has reported a bug for option 1 in load balanced situations, you can find the details here:  <a href="http://issues.umbraco.org/issue/U4-2879">http://issues.umbraco.org/issue/U4-2879</a></p>
<p>Thank you to Tom Fulton for his feedback and contributions to this article!</p>
<p><strong>For more information:</strong></p>
<p>CachedPartial - <a href="http://our.umbraco.org/documentation/Reference/Mvc/partial-views">http://our.umbraco.org/documentation/Reference/Mvc/partial-views</a><br>Profiling - <a href="http://msdn.microsoft.com/en-us/library/ms182372.aspx">http://msdn.microsoft.com/en-us/library/ms182372.aspx</a><br>Singletons - <a href="http://msdn.microsoft.com/en-us/library/ff650316.aspx">http://msdn.microsoft.com/en-us/library/ff650316.aspx</a></p>
    </div><footer><ul class="tags">
        <li><a rel="tag" href="https://24days.in/umbraco-cms/tags/caching/" title="See all articles tagged with Caching">Caching</a></li>
        <li><a rel="tag" href="https://24days.in/umbraco-cms/tags/v4/" title="See all articles tagged with v4">v4</a></li>
        <li><a rel="tag" href="https://24days.in/umbraco-cms/tags/v6/" title="See all articles tagged with v6">v6</a></li>
      </ul></footer><section class="bios"><div class="bio">
        <div class="gravatar" title="Kevin Giszewski"><img src="//gravatar.com/avatar/059edb298d5795ad9bc26fd57734d465.jpg?d=mm&amp;s=150" srcset="//gravatar.com/avatar/059edb298d5795ad9bc26fd57734d465.jpg?d=mm&amp;s=300 2x" width="150" height="150"></div>
        <h1>Kevin Giszewski</h1>
        <p>Kevin is on Twitter as <a href="//twitter.com/kevingiszewski" title="Kevin Giszewski on Twitter" rel="author">@kevingiszewski</a></p>
      </div></section><section class="comments"><div id="disqus_thread"></div></section></main><nav class="dates-navbar"><a href="/umbraco-cms/2013/" class="home-link"><span class="scr-text">Home</span></a><ol>
      <li><a title="Editor-proofing Umbraco" href="/umbraco-cms/2013/editor-proofing-umbraco/"><span class="scr-text">Editor-proofing Umbraco</span></a></li>
      <li><a title="All your logs are belong to log4net" href="/umbraco-cms/2013/log4net-in-umbraco/"><span class="scr-text">All your logs are belong to log4net</span></a></li>
      <li><a title="Bust a cache" href="/umbraco-cms/2013/cache-busting/"><span class="scr-text">Bust a cache</span></a></li>
      <li class="selected"><a title="Get More Out of Umbraco Using Server-Side Caching Strategies" href="/umbraco-cms/2013/get-more-out-of-umbraco-using-server-side-caching-strategies/"><span class="scr-text">Get More Out of Umbraco Using Server-Side Caching Strategies</span></a></li>
      <li><a title="How GitHub Snippets for Umbraco 7 was built" href="/umbraco-cms/2013/github-snippets-for-umbraco/"><span class="scr-text">How GitHub Snippets for Umbraco 7 was built</span></a></li>
      <li><a title="6 Easy Configuration Tweaks" href="/umbraco-cms/2013/6-easy-configuration-tweaks/"><span class="scr-text">6 Easy Configuration Tweaks</span></a></li>
      <li><a title="Mapping Umbraco content to POCOs for strongly typed views" href="/umbraco-cms/2013/mapping-content-to-pocos/"><span class="scr-text">Mapping Umbraco content to POCOs for strongly typed views</span></a></li>
      <li><a title="The worlds friendliest post on getting started with Examine" href="/umbraco-cms/2013/getting-started-with-examine/"><span class="scr-text">The worlds friendliest post on getting started with Examine</span></a></li>
      <li><a title="Creating reusable code in MVC apps" href="/umbraco-cms/2013/creating-reusable-code-in-mvc-apps/"><span class="scr-text">Creating reusable code in MVC apps</span></a></li>
      <li><a title="Why you should care about emotions when building a web shop" href="/umbraco-cms/2013/emotional-commerce/"><span class="scr-text">Why you should care about emotions when building a web shop</span></a></li>
      <li><a title="How And Why We Do Umbraco MVC" href="/umbraco-cms/2013/how-and-why-we-do-umbraco-mvc/"><span class="scr-text">How And Why We Do Umbraco MVC</span></a></li>
      <li><a title="The Dictionary Secrets" href="/umbraco-cms/2013/the-dictionary-secrets/"><span class="scr-text">The Dictionary Secrets</span></a></li>
      <li><a title="Data = Knowledge" href="/umbraco-cms/2013/data-=-knowledge/"><span class="scr-text">Data = Knowledge</span></a></li>
      <li><a title="Content-First in Umbraco" href="/umbraco-cms/2013/content-first/"><span class="scr-text">Content-First in Umbraco</span></a></li>
      <li><a title="Hybrid Framework" href="/umbraco-cms/2013/hybrid-framework/"><span class="scr-text">Hybrid Framework</span></a></li>
      <li><a title="The uSync Soft Shoe Shuffle" href="/umbraco-cms/2013/the-usync-soft-shoe-shuffle/"><span class="scr-text">The uSync Soft Shoe Shuffle</span></a></li>
      <li><a title="No More Empty Tabs, Please " href="/umbraco-cms/2013/empty-tabs/"><span class="scr-text">No More Empty Tabs, Please </span></a></li>
      <li><a title="Sharing is caring - The 301 Url Tracker" href="/umbraco-cms/2013/sharing-is-caring/"><span class="scr-text">Sharing is caring - The 301 Url Tracker</span></a></li>
      <li><a title="Umbraco V7 Compatible packages" href="/umbraco-cms/2013/v7-packages/"><span class="scr-text">Umbraco V7 Compatible packages</span></a></li>
      <li><a title="What's in a Document Type anyway?" href="/umbraco-cms/2013/documenttypes/"><span class="scr-text">What's in a Document Type anyway?</span></a></li>
      <li><a title="One member to rule them all" href="/umbraco-cms/2013/one-member-to-rule-them-all/"><span class="scr-text">One member to rule them all</span></a></li>
      <li><a title="Injecting the backoffice into the backoffice" href="/umbraco-cms/2013/injecting-the-backoffice-into-the-backoffice/"><span class="scr-text">Injecting the backoffice into the backoffice</span></a></li>
      <li><a title="Dashboard overload" href="/umbraco-cms/2013/dashboard-overload/"><span class="scr-text">Dashboard overload</span></a></li>
      <li><a title="Christmas Edition" href="/umbraco-cms/2013/christmas-edition/"><span class="scr-text">Christmas Edition</span></a></li>
    </ol></nav></section>


	<script type="module" src="/assets/ipuzzler.js"></script>
	<script defer src="/assets/libs.min.js"></script>
	<script defer src="/assets/app.js"></script>
	
</body>
</html>
