<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">


	<title>Getting data in and out of complex Archetype data types</title>
<meta name="description" content="Getting data out of an Archetype data type, updating the data and saving it back to Umbraco">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="/assets/24days-archive.css">
	<link rel="apple-touch-icon" href="/assets/24days-touch-icon.png">
		
	
	
</head>
<body>
	



<section class="page"><main class="article"><header><h1 class="header">Getting data in and out of complex Archetype data types</h1>
      <p class="byline"> by Maff Rigby, <span class="pubdate">posted on <time datetime="2014-12-03">Dec 3, 2014</time></span></p></header><div class="notification warning">
      <h2>Heads Up!</h2>
      <p>
					This article is several years old now, and much has happened since then,
					so please keep that in mind while reading it.
				</p>
    </div>
    <div class="content-column">
      <p class="teaser">If you haven't already discovered Archetype then you should give yourself an early Christmas present and install it in your current Umbraco project - it's awesome!</p>
<p class="intro">What does it do? Well it allows you to build your own custom data types that contain other data types. You can even get really ambitious (like I did) and create Archetype data types that contain other Archetype data types! It's like the movie Inception is actually happening right in front of your eyes, except it's in code version and nobody (hopefully) dies.</p>
<p>The drawback of creating your own Hollywood blockbuster style data types is that once you've created your data type and added your data to it, you then have to somehow get the data out and onto your web page! And if you're even more ambitious (like I was) you will have to update that data and save it back to your Archetype data type!</p>
<p>"Surely something that complex isn't possible!" you scream in horror. Well relax - I've done it and I'm still here to tell the tale. Also I'm going to show you in this very article how you too can create and use these complex Archetype data types. This is my Christmas present to you. Something to wow the relatives with over your Christmas turkey, or impress the guests at your New Year's Eve soiree!</p>
<p>First a bit of background - the project I've been working on recently uses a number of opinion polls. These opinion polls typically have a question and two or three possible answers. Here's what one of those opinion polls could possibly look like:</p>
<p><img src="/archive/media/2014/sample_opinion_poll_495x220.jpg" width="495" height="220" alt="Sample Opinion Poll"></p>
<p>The number of answers for any opinion poll can vary and I didn't want to hard-code these as properties, so I needed a data type where you could dynamically add 3, 4 or 10 answers to an opinion poll without any hassle.</p>
<p>Also the votes for the opinion polls needed to be easily viewable by the client, which meant they had to be accessible through Umbraco. I could have done this by storing the answers to a database, building a custom Admin section where you could see each opinion poll and the associated answers, and adding that into the Umbraco back end, but that sounded like a lot of work and a somewhat over-engineered solution. So I decided to store the opinion poll results in the actual opinion poll questions themselves, and that's why I chose to use Archetype.</p>
<p>First I created the Archetype data type for my Answer, that I called "Opinion Poll Answer" (clever eh?). This consists of an Textstring property called "Answer" which contains a possible answer for the poll, and a Numeric property called "Votes" which is used to record how many users have chosen that specific answer:</p>
<p><img src="/archive/media/2014/answer_archetype_496x280.jpg" width="496" height="280" alt="Answer Archetype"></p>
<p>I enabled "Multiple Fieldsets" on this data type (in the data type editor if you toggle the Advanced Options you will see the option there) which enables the editor creating a new opinion poll in Umbraco to add as many answers as they like.</p>
<p>Next I created the Archetype data type for my Question, which contained a Textstring property called "Question" to hold the poll question text, and the Opinion Poll Answer data type that I just created:</p>
<p><img src="/archive/media/2014/question_archetype_500x249.jpg" width="500" height="249" alt="Question Archetype"></p>
<p>So now I had my data type set up and added as a property into my Opinion Poll document type, I could create exciting looking polls like this one:</p>
<p><img src="/archive/media/2014/opinion_poll_content_item_499x250.jpg" width="499" height="250" alt="Opinion Poll Content Item"></p>
<p>As you can see, the votes for each answer are stored within the actual answers, and there's a "Total Votes" property that I used to work out voting percentages.</p>
<p>Now came the fun part - I had to get the data out of my awesome data type and on to the page! Are you ready for some code?</p>
<p>I do this all in a helper class rather than clogging up my Surface Controller, so first off I retrieve the poll content item:</p>
<pre class="language-csharp"><code>var poll = new umbraco.NodeFactory.Node(pollId);</code></pre>
<p>Then I deserialize the "answers" property of that content item into an ArchetypeModel object:</p>
<pre class="language-csharp"><code>var answers = 
  JsonConvert.DeserializeObject&lt;ArchetypeModel&gt;(poll.GetProperty("answers").Value);</code></pre>
<p>Finally I loop through the Fieldsets of that ArchetypeModel object and add the "Answer" and "Votes" values to my view model:</p>
<pre class="language-csharp"><code>foreach (var answer in answers.Fieldsets.Where(x =&gt; x != null &amp;&amp; x.Properties.Any()))
  {
	var thisAnswer = answer.GetValue("answer");
	var thisVotes = answer.GetValue&lt;double&gt;("votes");

	model.Answers.Add(new OpinionPollAnswer
	{
	  Answer = thisAnswer,
	  PercentageVotes = (Convert.ToInt32(totalVotes) != 0) 
	    ? (int)Math.Round((thisVotes / totalVotes) * 100) : 0
	});
  }</code></pre>
<p>So that's not too tricky really, once you know what you need to do to get the data out. Getting the data back in is the tricky part, because first you need to get the data out (i.e. repeat what I just did there), then you need to update the data, and finally you need to put the data back in to your content item!</p>
<p>So once a user chooses an answer to my opinion poll and clicks 'submit', I get the poll content item that I want to update and put it into the "pollToUpdate" variable:</p>
<pre class="language-csharp"><code>var pollToUpdate = _contentService.GetById(model.PollId);</code></pre>
<p>Then I increment the total votes property by 1:</p>
<pre class="language-csharp"><code>var totalVotesProperty = pollToUpdate.Properties.FirstOrDefault(x =&gt; x.Alias == "totalVotes");

if (totalVotesProperty != null)
{
  var totalVotes = (!string.IsNullOrEmpty(totalVotesProperty.Value.ToString())) 
    ? Convert.ToInt32(totalVotesProperty.Value) : 0;
  
  totalVotes++;

  pollToUpdate.SetValue("totalVotes", totalVotes);
}</code></pre>
<p>Next comes the big finale - I deserialize the "Answer" property of the opinion poll content item into an ArchetypeModel object. I then loop through the ArchetypeModel object's Fieldsets and find the Answer that matches the one that has been submitted.</p>
<p>Then I retrieve the "Votes" property of that answer and increment it by 1 before assigning it back to the "Votes" property.</p>
<p>I then put the data back into the pollToUpdate object by serializing my ArchetypeModel object, and using the "SetValue" method of my content item:</p>
<pre class="language-csharp"><code>var selectedAnswer = model.SelectedAnswer;

var pollProperties = pollToUpdate.Properties.FirstOrDefault(x =&gt; x.Alias == "answers");
  
if (pollProperties != null)
{
  var answerToUpdate = 
    JsonConvert.DeserializeObject&lt;ArchetypeModel&gt;(pollProperties.Value.ToString());

  foreach (var answer in answerToUpdate.Fieldsets)
  {
	if (answer.GetValue("answer") == selectedAnswer)
	{
	var answerVote = answer.GetValue&lt;int&gt;("votes");
	  
	answerVote++;

	var answerProperty = answer.Properties.FirstOrDefault(x =&gt; x.Alias == "votes");

	if (answerProperty != null)
	  answerProperty.Value = answerVote;
    }
  }

  pollToUpdate.SetValue("answers", JsonConvert.SerializeObject(answerToUpdate));
}</code></pre>
<p>Finally I save my updated content item back to Umbraco using the ContentService's SaveAndPublishWithStatus method:</p>
<pre class="language-csharp"><code>_contentService.SaveAndPublishWithStatus(pollToUpdate);</code></pre>
<p>So there you go - that's how you get data in and out of complex Archetype Data Types! As with most code things, if you haven't done it before it can take you quite some time to figure out what to do. That's why I've shared this article - to hopefully help somebody somewhere to do the same thing at some point in the future and save themselves a load of hassle trying to figure it out! I hope you found reading this interestina and useful, or failing that I hope that reading it has kept you busy enough to avoid having to peel the sprouts on Christmas Day!</p>
    </div><footer><ul class="tags">
        <li><a rel="tag" href="https://24days.in/umbraco-cms/tags/content/" title="See all articles tagged with Content">Content</a></li>
        <li><a rel="tag" href="https://24days.in/umbraco-cms/tags/package/" title="See all articles tagged with Package">Package</a></li>
        <li><a rel="tag" href="https://24days.in/umbraco-cms/tags/v7/" title="See all articles tagged with v7">v7</a></li>
      </ul></footer><section class="bios"><div class="bio">
        <div class="gravatar" title="Maff Rigby"><img width="150" height="150" src="/archive/media/2014/digital_maff_white.png?width=150" srcset="/archive/media/2014/digital_maff_white.png?width=300 2x"></div>
        <h1>Maff Rigby</h1>
        <p>Maff is on Twitter as <a href="//twitter.com/MaffRigby" title="Maff Rigby on Twitter" rel="author">@MaffRigby</a></p>
      </div></section><section class="comments"><div id="disqus_thread"></div></section></main><nav class="dates-navbar"><a href="/umbraco-cms/2014/" class="home-link"><span class="scr-text">Home</span></a><ol>
      <li><a title="The Umbraco Codebase: A Traveller's Guide" href="/umbraco-cms/2014/traveller-guide/"><span class="scr-text">The Umbraco Codebase: A Traveller's Guide</span></a></li>
      <li><a title="Debugging AngularJS" href="/umbraco-cms/2014/debugging-angularjs/"><span class="scr-text">Debugging AngularJS</span></a></li>
      <li class="selected"><a title="Getting data in and out of complex Archetype data types" href="/umbraco-cms/2014/working-with-complex-archetype-datatypes/"><span class="scr-text">Getting data in and out of complex Archetype data types</span></a></li>
      <li><a title="Your first pull request" href="/umbraco-cms/2014/your-first-pull-request/"><span class="scr-text">Your first pull request</span></a></li>
      <li><a title="Dealing With Members Using The MemberService &amp; MembershipHelper" href="/umbraco-cms/2014/dealing-with-members/"><span class="scr-text">Dealing With Members Using The MemberService &amp; MembershipHelper</span></a></li>
      <li><a title="The Double Album" href="/umbraco-cms/2014/the-double-album/"><span class="scr-text">The Double Album</span></a></li>
      <li><a title="Managing Members in Umbraco" href="/umbraco-cms/2014/managing-members/"><span class="scr-text">Managing Members in Umbraco</span></a></li>
      <li><a title="Making an Angular-powered frontend with Umbraco" href="/umbraco-cms/2014/angular-powered-frontend/"><span class="scr-text">Making an Angular-powered frontend with Umbraco</span></a></li>
      <li><a title="Architectural thoughts when using Umbraco in Multi-platform solutions" href="/umbraco-cms/2014/architectural-thoughts/"><span class="scr-text">Architectural thoughts when using Umbraco in Multi-platform solutions</span></a></li>
      <li><a title="How to take full advantage of macros within the Umbraco 7.2 grid" href="/umbraco-cms/2014/grid-macros/"><span class="scr-text">How to take full advantage of macros within the Umbraco 7.2 grid</span></a></li>
      <li><a title="Newbie's Guide to Setting Up an Umbraco Website" href="/umbraco-cms/2014/how-to-set-up-an-umbraco-site/"><span class="scr-text">Newbie's Guide to Setting Up an Umbraco Website</span></a></li>
      <li><a title="Upgrading Umbraco using Git" href="/umbraco-cms/2014/upgrading-umbraco-using-git/"><span class="scr-text">Upgrading Umbraco using Git</span></a></li>
      <li><a title="Architecture based on IoC/DI for Umbraco packages" href="/umbraco-cms/2014/iocdi-architecture/"><span class="scr-text">Architecture based on IoC/DI for Umbraco packages</span></a></li>
      <li><a title="Using Angular in the backoffice - Some useful tips" href="/umbraco-cms/2014/umbraco-angular-tips/"><span class="scr-text">Using Angular in the backoffice - Some useful tips</span></a></li>
      <li><a title="Build a simple contextual language switcher" href="/umbraco-cms/2014/razor-language-switcher/"><span class="scr-text">Build a simple contextual language switcher</span></a></li>
      <li><a title="All Your Images Are Belong to Umbraco" href="/umbraco-cms/2014/all-your-images-are-belong-to-umbraco/"><span class="scr-text">All Your Images Are Belong to Umbraco</span></a></li>
      <li><a title="Modify Umbraco URLs with the UrlProvider and ContentFinder" href="/umbraco-cms/2014/urlprovider-and-contentfinder/"><span class="scr-text">Modify Umbraco URLs with the UrlProvider and ContentFinder</span></a></li>
      <li><a title="Umbraco Packaging with AppVeyor CI" href="/umbraco-cms/2014/packaging-with-appveyor/"><span class="scr-text">Umbraco Packaging with AppVeyor CI</span></a></li>
      <li><a title="Have beer - looking for workers" href="/umbraco-cms/2014/umbraco-tribe/"><span class="scr-text">Have beer - looking for workers</span></a></li>
      <li><a title="Extending Umbraco 7 backend" href="/umbraco-cms/2014/extending-umbraco-7-backend/"><span class="scr-text">Extending Umbraco 7 backend</span></a></li>
      <li><a title="Redirect rules" href="/umbraco-cms/2014/redirect-rules/"><span class="scr-text">Redirect rules</span></a></li>
      <li><a title="Faceted Search with Bobo" href="/umbraco-cms/2014/search-with-bobo/"><span class="scr-text">Faceted Search with Bobo</span></a></li>
      <li><a title="The Merchello Contribution" href="/umbraco-cms/2014/the-merchello-contribution/"><span class="scr-text">The Merchello Contribution</span></a></li>
      <li><a title="The power of (Christmas) card modes" href="/umbraco-cms/2014/card-modes/"><span class="scr-text">The power of (Christmas) card modes</span></a></li>
      <li><a title="The EPUB is here" href="/umbraco-cms/2014/epub/"><span class="scr-text">The EPUB is here</span></a></li>
    </ol></nav></section>


	<script type="module" src="/assets/ipuzzler.js"></script>
	<script defer src="/assets/libs.min.js"></script>
	<script defer src="/assets/app.js"></script>
	
</body>
</html>
